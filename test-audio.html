<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Test - Discord Activity</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
        }
        button {
            background: #5865F2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        button:hover {
            background: #4752C4;
        }
        .log {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: #43b581; }
        .error { color: #f04747; }
        .info { color: #7289da; }
        .warning { color: #faa61a; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üéµ Discord Activity Audio Test</h1>

        <h2>Environment Check</h2>
        <div id="env-info"></div>

        <h2>Audio Source Tests</h2>
        <button onclick="testProxyAudio()">Test Proxy URL (/r2-audio/)</button>
        <button onclick="testDirectR2Audio()">Test Direct R2 URL</button>
        <button onclick="testClearCache()">Clear & Retry</button>

        <h2>Audio Player</h2>
        <audio id="test-audio" controls crossorigin="anonymous"></audio>

        <h2>Console Log</h2>
        <div id="log" class="log"></div>
    </div>

    <script>
        const logEl = document.getElementById('log');
        const audioEl = document.getElementById('test-audio');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = type;
            entry.textContent = `[${timestamp}] ${message}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
            console.log(message);
        }

        // Environment detection
        function checkEnvironment() {
            const envInfo = document.getElementById('env-info');
            const inIframe = window.self !== window.top;
            const urlParams = new URLSearchParams(window.location.search);
            const hasDiscordParams = urlParams.has('frame_id') || urlParams.has('instance_id');
            const referrer = document.referrer;

            let html = '<ul>';
            html += `<li>In iframe: <strong>${inIframe ? 'Yes' : 'No'}</strong></li>`;
            html += `<li>Discord params: <strong>${hasDiscordParams ? 'Yes' : 'No'}</strong></li>`;
            html += `<li>Referrer: <strong>${referrer || 'None'}</strong></li>`;
            html += `<li>Location: <strong>${window.location.href}</strong></li>`;
            html += '</ul>';

            envInfo.innerHTML = html;

            log('Environment check complete', 'success');
            if (inIframe || hasDiscordParams) {
                log('üéÆ Running in Discord Activity mode!', 'warning');
            } else {
                log('üíª Running in normal browser mode', 'info');
            }
        }

        // Test proxy URL
        async function testProxyAudio() {
            const url = '/r2-audio/(01) beyond the oceans (feat. Hoogway).mp3';
            log(`Testing proxy URL: ${url}`, 'info');

            audioEl.src = '';
            audioEl.load();

            try {
                // Try to fetch the URL first
                const response = await fetch(url, { method: 'HEAD' });
                log(`‚úÖ Fetch response: ${response.status} ${response.statusText}`, 'success');
                log(`   Content-Type: ${response.headers.get('content-type')}`, 'info');
                log(`   Content-Length: ${response.headers.get('content-length')}`, 'info');

                // Set audio source
                audioEl.src = url;
                log('Audio source set, waiting for loadedmetadata...', 'info');
            } catch (err) {
                log(`‚ùå Fetch failed: ${err.message}`, 'error');
            }
        }

        // Test direct R2 URL
        async function testDirectR2Audio() {
            const url = 'https://pub-7e068d8c526a459ea67ff46fe3762059.r2.dev/music/(01) beyond the oceans (feat. Hoogway).mp3';
            log(`Testing direct R2 URL: ${url}`, 'info');

            audioEl.src = '';
            audioEl.load();

            try {
                const response = await fetch(url, { method: 'HEAD' });
                log(`‚úÖ Fetch response: ${response.status} ${response.statusText}`, 'success');
                log(`   Content-Type: ${response.headers.get('content-type')}`, 'info');

                audioEl.src = url;
                log('Audio source set, waiting for loadedmetadata...', 'info');
            } catch (err) {
                log(`‚ùå Fetch failed: ${err.message}`, 'error');
            }
        }

        // Clear cache
        function testClearCache() {
            audioEl.src = '';
            audioEl.load();
            log('Audio element cleared', 'warning');
        }

        // Audio event listeners
        audioEl.addEventListener('loadedmetadata', () => {
            log(`‚úÖ Audio loaded! Duration: ${audioEl.duration.toFixed(2)}s`, 'success');
        });

        audioEl.addEventListener('error', (e) => {
            const error = audioEl.error;
            let errorMsg = 'Unknown error';
            if (error) {
                switch(error.code) {
                    case 1: errorMsg = 'MEDIA_ERR_ABORTED'; break;
                    case 2: errorMsg = 'MEDIA_ERR_NETWORK'; break;
                    case 3: errorMsg = 'MEDIA_ERR_DECODE'; break;
                    case 4: errorMsg = 'MEDIA_ERR_SRC_NOT_SUPPORTED'; break;
                }
                errorMsg += ` - ${error.message}`;
            }
            log(`‚ùå Audio error: ${errorMsg}`, 'error');
            log(`   Current src: ${audioEl.src}`, 'error');
        });

        audioEl.addEventListener('canplay', () => {
            log('‚úÖ Audio can play (enough data loaded)', 'success');
        });

        audioEl.addEventListener('play', () => {
            log('‚ñ∂Ô∏è Audio started playing', 'success');
        });

        // Initialize
        checkEnvironment();
        log('Ready to test! Click a button above to start.', 'info');
    </script>
</body>
</html>
